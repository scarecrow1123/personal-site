<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Exploring Jsonnet | Ananda Seelan</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Exploring Jsonnet" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A walkthrough of how a deep learning experiment configuration can be written in Jsonnet" />
<meta property="og:description" content="A walkthrough of how a deep learning experiment configuration can be written in Jsonnet" />
<link rel="canonical" href="https://scarecrow1123.github.io/personal-site/deep-learning/software/2019/07/06/jsonnet.html" />
<meta property="og:url" content="https://scarecrow1123.github.io/personal-site/deep-learning/software/2019/07/06/jsonnet.html" />
<meta property="og:site_name" content="Ananda Seelan" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-07-06T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"A walkthrough of how a deep learning experiment configuration can be written in Jsonnet","url":"https://scarecrow1123.github.io/personal-site/deep-learning/software/2019/07/06/jsonnet.html","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://scarecrow1123.github.io/personal-site/deep-learning/software/2019/07/06/jsonnet.html"},"headline":"Exploring Jsonnet","dateModified":"2019-07-06T00:00:00-05:00","datePublished":"2019-07-06T00:00:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/personal-site/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://scarecrow1123.github.io/personal-site/feed.xml" title="Ananda Seelan" /><link rel="shortcut icon" type="image/x-icon" href="/personal-site/images/favicon.ico"><link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><script src="https://hypothes.is/embed.js" async></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/personal-site/">Ananda Seelan</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/personal-site/about/">About Me</a><a class="page-link" href="/personal-site/search/">Search</a><a class="page-link" href="/personal-site/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Exploring Jsonnet</h1><p class="page-description">A walkthrough of how a deep learning experiment configuration can be written in Jsonnet</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2019-07-06T00:00:00-05:00" itemprop="datePublished">
        Jul 6, 2019
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      6 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/personal-site/categories/#deep-learning">deep-learning</a>
        &nbsp;
      
        <a class="category-tags-link" href="/personal-site/categories/#software">software</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h3"><a href="#jsonnet">Jsonnet</a></li>
<li class="toc-entry toc-h3"><a href="#sample-configuration">Sample Configuration</a>
<ul>
<li class="toc-entry toc-h5"><a href="#mnist_feedforwardjsonnet">mnist_feedforward.jsonnet</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#variables">Variables</a>
<ul>
<li class="toc-entry toc-h5"><a href="#mnist_feedforwardjsonnet-1">mnist_feedforward.jsonnet</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#objects">Objects</a>
<ul>
<li class="toc-entry toc-h5"><a href="#mnist_convjsonnet">mnist_conv.jsonnet</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#functions">Functions</a>
<ul>
<li class="toc-entry toc-h5"><a href="#mnist_convjsonnet-1">mnist_conv.jsonnet</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#imports">Imports</a>
<ul>
<li class="toc-entry toc-h5"><a href="#lib-mnistlibsonnet">lib-mnist.libsonnet</a></li>
<li class="toc-entry toc-h5"><a href="#mnist_feedforwardjsonnet-2">mnist_feedforward.jsonnet</a></li>
<li class="toc-entry toc-h5"><a href="#mnist_convjsonnet-2">mnist_conv.jsonnet</a></li>
</ul>
</li>
</ul><p>I found <a href="https://jsonnet.org/">Jsonnet</a> through AllenNLP. Hence a few words on that first. We use <a href="https://github.com/allenai/allennlp">AllenNLP</a> for writing our Deep Learning experiments in our team. It is primarily built for doing NLP research on top of PyTorch. However, the abstractions in the library are well designed and easily extensible that it can actually be used for building any fairly straightforward neural network experiments. Perhaps I would write a separate post on how to adopt AllenNLP for non-NLP experiments, but <a href="https://github.com/allenai/allennlp/issues/2099#issuecomment-450190095">here is an example</a> of how it has been used for Computer Vision.</p>

<h3 id="jsonnet">
<a class="anchor" href="#jsonnet" aria-hidden="true"><span class="octicon octicon-link"></span></a>Jsonnet</h3>

<p>Jsonnet is a DSL for creating data templates and comes in handy to generate JSON based configuration data. It comes with a standard library <code class="language-plaintext highlighter-rouge">std</code> that includes features like list comprehension, string manipulation, etc. It is primarily meant for generating configuration files. <code class="language-plaintext highlighter-rouge">std</code> has a bunch of manifestation utilities that can be used to convert the template to generate targets in <code class="language-plaintext highlighter-rouge">.ini</code>, <code class="language-plaintext highlighter-rouge">.yaml</code>. For a robust templating language with more complex needs however, I’d suggest to use the awesome <a href="https://www.stringtemplate.org/">StringTemplate</a>.</p>

<p>AllenNLP uses Jsonnet for writing experiment configurations. In other words, the dependencies for running an AllenNLP experiment are specified in a <code class="language-plaintext highlighter-rouge">.jsonnet</code> file and the objects are constructed using built in factories. Below is a section from a configuration that defines a simple feedforward MNIST classifier network:</p>

<h3 id="sample-configuration">
<a class="anchor" href="#sample-configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sample Configuration</h3>

<h5 id="mnist_feedforwardjsonnet">
<a class="anchor" href="#mnist_feedforwardjsonnet" aria-hidden="true"><span class="octicon octicon-link"></span></a>mnist_feedforward.jsonnet</h5>

<div class="language-jsonnet highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
    <span class="c1">// .....</span>
    <span class="s">"model"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"mnist_encoder"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"num_layers"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s">"activations"</span><span class="p">:</span> <span class="p">[</span><span class="s">"relu"</span><span class="p">,</span> <span class="s">"relu"</span><span class="p">],</span>
            <span class="s">"input_dim"</span><span class="p">:</span> <span class="mi">784</span><span class="p">,</span>
            <span class="s">"hidden_dims"</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span>
            <span class="s">"dropout"</span><span class="p">:</span> <span class="mf">0.25</span>
        <span class="p">},</span>
        <span class="s">"projection_layer"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"num_layers"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s">"activations"</span><span class="p">:</span> <span class="s">"relu"</span><span class="p">,</span>
            <span class="s">"input_dim"</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span>
            <span class="s">"hidden_dims"</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
            <span class="s">"dropout"</span><span class="p">:</span> <span class="mf">0.25</span>
        <span class="p">},</span>
        <span class="s">"final_layer"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"num_layers"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s">"activations"</span><span class="p">:</span> <span class="s">"linear"</span><span class="p">,</span>
            <span class="s">"input_dim"</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
            <span class="s">"hidden_dims"</span><span class="p">:</span> <span class="mi">10</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// .....</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="variables">
<a class="anchor" href="#variables" aria-hidden="true"><span class="octicon octicon-link"></span></a>Variables</h3>

<p>One minor quibble with the above config: when running multiple experiments, the most obvious thing one would do is to change those numbers in every layer. Say to increase the output dimension of the <code class="language-plaintext highlighter-rouge">mnist_encoder</code>, <code class="language-plaintext highlighter-rouge">input_dim</code> of <code class="language-plaintext highlighter-rouge">projection_layer</code> needs to be adjusted too. For a more complex architecture, there is a good possibility that this would lead to a chain of changes to be done manually.</p>

<p>Obvious thing to do now is to use variables. In the below example, notice how the same variable is used for configuring both the output and input sizes of <code class="language-plaintext highlighter-rouge">mnist_encoder</code> and <code class="language-plaintext highlighter-rouge">projection_layer</code> layers respectively.</p>

<h5 id="mnist_feedforwardjsonnet-1">
<a class="anchor" href="#mnist_feedforwardjsonnet-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>mnist_feedforward.jsonnet</h5>

<div class="language-jsonnet highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">local</span> <span class="nx">INPUT_SIZE</span> <span class="p">=</span> <span class="mi">784</span><span class="p">;</span>
<span class="k">local</span> <span class="nx">INPUT_ENCODER_OUTPUT_SIZE</span> <span class="p">=</span> <span class="mi">512</span><span class="p">;</span>
<span class="k">local</span> <span class="nx">PROJECTION_SIZE</span> <span class="p">=</span> <span class="mi">64</span><span class="p">;</span>
<span class="k">local</span> <span class="nx">FINAL_OUTPUT_SIZE</span> <span class="p">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="k">local</span> <span class="nx">DROPOUT</span> <span class="p">=</span> <span class="mf">0.25</span><span class="p">;</span>

<span class="p">{</span>
    <span class="c1">// .....</span>
    <span class="s">"model"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"mnist_encoder"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"num_layers"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s">"activations"</span><span class="p">:</span> <span class="p">[</span><span class="s">"relu"</span><span class="p">,</span> <span class="s">"relu"</span><span class="p">],</span>
            <span class="s">"input_dim"</span><span class="p">:</span> <span class="nx">INPUT_SIZE</span><span class="p">,</span>
            <span class="s">"hidden_dims"</span><span class="p">:</span> <span class="nx">INPUT_ENCODER_OUTPUT_SIZE</span><span class="p">,</span>
            <span class="s">"dropout"</span><span class="p">:</span> <span class="nx">DROPOUT</span>
        <span class="p">},</span>
        <span class="s">"projection_layer"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"num_layers"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s">"activations"</span><span class="p">:</span> <span class="s">"relu"</span><span class="p">,</span>
            <span class="s">"input_dim"</span><span class="p">:</span> <span class="nx">INPUT_ENCODER_OUTPUT_SIZE</span><span class="p">,</span>
            <span class="s">"hidden_dims"</span><span class="p">:</span> <span class="nx">PROJECTION_SIZE</span><span class="p">,</span>
            <span class="s">"dropout"</span><span class="p">:</span> <span class="mf">0.25</span>
        <span class="p">},</span>
        <span class="s">"final_layer"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"num_layers"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s">"activations"</span><span class="p">:</span> <span class="s">"linear"</span><span class="p">,</span>
            <span class="s">"input_dim"</span><span class="p">:</span> <span class="nx">PROJECTION_SIZE</span><span class="p">,</span>
            <span class="s">"hidden_dims"</span><span class="p">:</span> <span class="nx">FINAL_OUTPUT_SIZE</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// .....</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="objects">
<a class="anchor" href="#objects" aria-hidden="true"><span class="octicon octicon-link"></span></a>Objects</h3>

<p>The next natural step of the experiment is to try different types of layers. In the above example <code class="language-plaintext highlighter-rouge">mnist_encoder</code> is a feedforward block. It could be a convolution based encoder as below:</p>

<h5 id="mnist_convjsonnet">
<a class="anchor" href="#mnist_convjsonnet" aria-hidden="true"><span class="octicon octicon-link"></span></a>mnist_conv.jsonnet</h5>

<div class="language-jsonnet highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">local</span> <span class="nx">ConvSpec</span> <span class="p">=</span> <span class="p">{</span>
    <span class="s">"num_layers"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s">"input_dim"</span><span class="p">:</span> <span class="mi">784</span><span class="p">,</span>
    <span class="s">"kernels"</span><span class="p">:</span> <span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span>
    <span class="s">"stride"</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="s">"activations"</span><span class="p">:</span> <span class="p">[</span><span class="s">"relu"</span><span class="p">,</span> <span class="s">"relu"</span><span class="p">],</span>
    <span class="s">"output_channels"</span><span class="p">:</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">]</span>
<span class="p">};</span>
<span class="p">{</span>
    <span class="c1">// ....</span>
    <span class="s">"model"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"mnist_encoder"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"type"</span><span class="p">:</span> <span class="s">"conv2d"</span>
            <span class="s">"num_layers"</span><span class="p">:</span> <span class="nx">ConvSpec</span><span class="p">.</span><span class="nx">num_layers</span><span class="p">,</span>
            <span class="s">"input_dim"</span><span class="p">:</span> <span class="nx">ConvSpec</span><span class="p">.</span><span class="nx">input_dim</span><span class="p">,</span>
            <span class="s">"output_channels"</span><span class="p">:</span> <span class="nx">ConvSpec</span><span class="p">.</span><span class="nx">output_channels</span><span class="p">,</span>
            <span class="s">"kernels"</span><span class="p">:</span> <span class="nx">ConvSpec</span><span class="p">.</span><span class="nx">kernels</span><span class="p">,</span>
            <span class="s">"stride"</span><span class="p">:</span> <span class="nx">ConvSpec</span><span class="p">.</span><span class="nx">stride</span><span class="p">,</span>
            <span class="s">"activations"</span><span class="p">:</span> <span class="nx">ConvSpec</span><span class="p">.</span><span class="nx">activations</span>
        <span class="p">},</span>
        <span class="c1">// ....</span>
    <span class="p">},</span>
    <span class="c1">// .....</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here <code class="language-plaintext highlighter-rouge">ConvSpec</code> is a jsonnet object with a bunch of member attributes that defines how the convolution block is used in the classifier. Jsonnet also supports inheritance of objects as shown <a href="https://jsonnet.org/learning/tutorial.html">here</a>.</p>

<h3 id="functions">
<a class="anchor" href="#functions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Functions</h3>

<p>The subsequent layers such as <code class="language-plaintext highlighter-rouge">projection_layer</code> and <code class="language-plaintext highlighter-rouge">final_layer</code> are going to be present in the conv example too and the <code class="language-plaintext highlighter-rouge">projection_layer</code> needs an input size to be defined. This will be output size of the conv layer and hardcoding this number is going to cause the same set of problems that we saw above in the first example. Let’s define a simple function that computes the output sizes of each layer in a conv block.</p>

<div class="language-jsonnet highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">local</span> <span class="nx">conv_output</span><span class="p">(</span><span class="nx">dim</span><span class="p">,</span> <span class="nx">kernel</span><span class="p">,</span> <span class="nx">stride</span><span class="p">,</span> <span class="nx">padding</span><span class="p">,</span> <span class="nx">dilation</span><span class="p">)</span> <span class="p">=</span> <span class="nx">std</span><span class="p">.</span><span class="nb">floor</span><span class="p">(((</span><span class="nx">dim</span> <span class="p">+</span> <span class="mi">2</span> <span class="err">*</span> <span class="nx">padding</span> <span class="err">-</span> <span class="nx">dilation</span> <span class="err">*</span> <span class="p">(</span><span class="nx">kernel</span> <span class="err">-</span> <span class="mi">1</span><span class="p">)</span> <span class="mi">-1</span><span class="p">)</span> <span class="err">/</span> <span class="nx">stride</span><span class="p">)</span> <span class="p">+</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">local</span> <span class="nx">compute_conv_output_sizes</span><span class="p">(</span><span class="nx">conv_</span><span class="p">,</span> <span class="nx">input_size</span><span class="p">,</span> <span class="nx">axis</span><span class="p">,</span> <span class="nx">curr_idx</span><span class="p">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">sizes</span><span class="p">=[])</span> <span class="p">=</span>
    <span class="k">if</span> <span class="nx">curr_idx</span> <span class="err">&gt;</span><span class="p">=</span> <span class="nx">conv_</span><span class="p">.</span><span class="nx">num_layers</span> <span class="k">then</span>
        <span class="nx">sizes</span>
    <span class="k">else</span>
        <span class="k">if</span> <span class="nx">std</span><span class="p">.</span><span class="nb">length</span><span class="p">(</span><span class="nx">sizes</span><span class="p">)</span> <span class="p">==</span> <span class="mi">0</span> <span class="k">then</span>
            <span class="nx">compute_conv_output_sizes</span><span class="p">(</span><span class="nx">conv_</span><span class="p">,</span> <span class="nx">input_size</span><span class="p">,</span> <span class="nx">axis</span><span class="p">,</span> <span class="nx">curr_idx</span><span class="p">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="nx">conv_output</span><span class="p">(</span><span class="nx">input_size</span><span class="p">,</span> <span class="nx">conv_</span><span class="p">.</span><span class="nx">kernels</span><span class="p">[</span><span class="nx">curr_idx</span><span class="p">][</span><span class="nx">axis</span><span class="p">],</span> <span class="nx">conv_</span><span class="p">.</span><span class="nx">stride</span><span class="p">[</span><span class="nx">curr_idx</span><span class="p">][</span><span class="nx">axis</span><span class="p">],</span> <span class="nx">conv_</span><span class="p">.</span><span class="nx">padding</span><span class="p">[</span><span class="nx">curr_idx</span><span class="p">][</span><span class="nx">axis</span><span class="p">],</span> <span class="nx">conv_</span><span class="p">.</span><span class="nx">dilation</span><span class="p">[</span><span class="nx">curr_idx</span><span class="p">][</span><span class="nx">axis</span><span class="p">])])</span>
        <span class="k">else</span>
            <span class="nx">compute_conv_output_sizes</span><span class="p">(</span><span class="nx">conv_</span><span class="p">,</span> <span class="nx">input_size</span><span class="p">,</span> <span class="nx">axis</span><span class="p">,</span> <span class="nx">curr_idx</span><span class="p">+</span><span class="mi">1</span><span class="p">,</span> <span class="nx">sizes</span> <span class="p">+</span> <span class="p">[</span><span class="nx">conv_output</span><span class="p">(</span><span class="nx">sizes</span><span class="p">[</span><span class="nx">std</span><span class="p">.</span><span class="nb">length</span><span class="p">(</span><span class="nx">sizes</span><span class="p">)</span><span class="mi">-1</span><span class="p">],</span> <span class="nx">conv_</span><span class="p">.</span><span class="nx">kernels</span><span class="p">[</span><span class="nx">curr_idx</span><span class="p">][</span><span class="nx">axis</span><span class="p">],</span> <span class="nx">conv_</span><span class="p">.</span><span class="nx">stride</span><span class="p">[</span><span class="nx">curr_idx</span><span class="p">][</span><span class="nx">axis</span><span class="p">],</span> <span class="nx">conv_</span><span class="p">.</span><span class="nx">padding</span><span class="p">[</span><span class="nx">curr_idx</span><span class="p">][</span><span class="nx">axis</span><span class="p">],</span> <span class="nx">conv_</span><span class="p">.</span><span class="nx">dilation</span><span class="p">[</span><span class="nx">curr_idx</span><span class="p">][</span><span class="nx">axis</span><span class="p">])]);</span>

</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">compute_conv_output_sizes</code> is a tail recursive function calculates the output size of each conv layer based on the defined kernel size, stride, padding and dilation.</p>

<p>Let’s incorporate this definition in the <code class="language-plaintext highlighter-rouge">mnist_encoder</code> example:</p>

<h5 id="mnist_convjsonnet-1">
<a class="anchor" href="#mnist_convjsonnet-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>mnist_conv.jsonnet</h5>

<div class="language-jsonnet highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">local</span> <span class="nx">ConvSpec</span> <span class="p">=</span> <span class="p">{</span>
    <span class="s">"num_layers"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s">"input_dim"</span><span class="p">:</span> <span class="mi">784</span><span class="p">,</span>
    <span class="s">"kernels"</span><span class="p">:</span> <span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span>
    <span class="s">"stride"</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="s">"activations"</span><span class="p">:</span> <span class="p">[</span><span class="s">"relu"</span><span class="p">,</span> <span class="s">"relu"</span><span class="p">],</span>
    <span class="s">"output_channels"</span><span class="p">:</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">],</span>
    <span class="s">"output_sizes"</span><span class="p">:</span> <span class="nx">compute_conv_output_sizes</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="k">self</span><span class="p">.</span><span class="nx">input_dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s">"output_size"</span><span class="p">:</span> <span class="k">self</span><span class="p">.</span><span class="nx">output_sizes</span><span class="p">[</span><span class="mi">-1</span><span class="p">]</span>
<span class="p">};</span>
<span class="p">{</span>
    <span class="c1">// ....</span>
    <span class="s">"model"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"mnist_encoder"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"type"</span><span class="p">:</span> <span class="s">"conv2d"</span>
            <span class="s">"num_layers"</span><span class="p">:</span> <span class="nx">ConvSpec</span><span class="p">.</span><span class="nx">num_layers</span><span class="p">,</span>
            <span class="s">"input_dim"</span><span class="p">:</span> <span class="nx">ConvSpec</span><span class="p">.</span><span class="nx">input_dim</span><span class="p">,</span>
            <span class="s">"output_channels"</span><span class="p">:</span> <span class="nx">ConvSpec</span><span class="p">.</span><span class="nx">output_channels</span><span class="p">,</span>
            <span class="s">"kernels"</span><span class="p">:</span> <span class="nx">ConvSpec</span><span class="p">.</span><span class="nx">kernels</span><span class="p">,</span>
            <span class="s">"stride"</span><span class="p">:</span> <span class="nx">ConvSpec</span><span class="p">.</span><span class="nx">stride</span><span class="p">,</span>
            <span class="s">"activations"</span><span class="p">:</span> <span class="nx">ConvSpec</span><span class="p">.</span><span class="nx">activations</span>
        <span class="p">},</span>
        <span class="c1">// ....</span>
    <span class="p">},</span>
    <span class="c1">// .....</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now a layer that follows <code class="language-plaintext highlighter-rouge">mnist_encoder</code> can make use of <code class="language-plaintext highlighter-rouge">ConvSpec.output_size</code> to configure its input sizes.</p>

<h3 id="imports">
<a class="anchor" href="#imports" aria-hidden="true"><span class="octicon octicon-link"></span></a>Imports</h3>

<p>So we have defined two variants of encoders here for a classifier. Except for the encoder all the other parts of the model configuration and training configuration are going to be the same. Let’s put the base scaffolding that defines the classifier in a <code class="language-plaintext highlighter-rouge">.libsonnet</code> file. This will serve as an importable lib that two different experiments can use.</p>

<h5 id="lib-mnistlibsonnet">
<a class="anchor" href="#lib-mnistlibsonnet" aria-hidden="true"><span class="octicon octicon-link"></span></a>lib-mnist.libsonnet</h5>
<div class="language-jsonnet highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
    <span class="nx">MNIST</span><span class="p">(</span><span class="nx">encoder</span><span class="p">,</span> <span class="nx">projection_size</span><span class="p">,</span> <span class="nx">final_output_size</span><span class="p">,</span> <span class="nx">dropout</span><span class="p">,</span> <span class="nx">num_projection_layers</span><span class="p">):</span> <span class="p">{</span>
    <span class="c1">// .....</span>
    <span class="s">"model"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">"mnist_encoder"</span><span class="p">:</span> <span class="nx">encoder</span><span class="p">,</span>
        <span class="s">"projection_layer"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"num_layers"</span><span class="p">:</span> <span class="nx">num_projection_layers</span><span class="p">,</span>
            <span class="s">"activations"</span><span class="p">:</span> <span class="s">"relu"</span><span class="p">,</span>
            <span class="s">"input_dim"</span><span class="p">:</span> <span class="k">if</span> <span class="nx">std</span><span class="p">.</span><span class="nb">objectHas</span><span class="p">(</span><span class="nx">encoder</span><span class="p">,</span> <span class="s">"type"</span><span class="p">)</span> <span class="k">then</span> <span class="nx">encoder</span><span class="p">.</span><span class="nx">output_size</span> <span class="k">else</span> <span class="nx">encoder</span><span class="p">.</span><span class="nx">hidden_dims</span><span class="p">,</span>
            <span class="s">"hidden_dims"</span><span class="p">:</span> <span class="nx">projection_size</span><span class="p">,</span>
            <span class="s">"dropout"</span><span class="p">:</span> <span class="nx">dropout</span>
        <span class="p">},</span>
        <span class="s">"final_layer"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"num_layers"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s">"activations"</span><span class="p">:</span> <span class="s">"linear"</span><span class="p">,</span>
            <span class="s">"input_dim"</span><span class="p">:</span> <span class="nx">projection_size</span><span class="p">,</span>
            <span class="s">"hidden_dims"</span><span class="p">:</span> <span class="nx">final_output_size</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// .....</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Notice above how the MNIST classifier has been parameterized which can be used from different variants of the architecture. Now, let’s redefine the feedforward variant to do the import.</p>

<h5 id="mnist_feedforwardjsonnet-2">
<a class="anchor" href="#mnist_feedforwardjsonnet-2" aria-hidden="true"><span class="octicon octicon-link"></span></a>mnist_feedforward.jsonnet</h5>
<div class="language-jsonnet highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">local</span> <span class="nx">lib</span> <span class="p">=</span> <span class="k">import</span> <span class="s">"lib-mnist.libsonnet"</span><span class="p">;</span>

<span class="k">local</span> <span class="nx">INPUT_SIZE</span> <span class="p">=</span> <span class="mi">784</span><span class="p">;</span>
<span class="k">local</span> <span class="nx">INPUT_ENCODER_OUTPUT_SIZE</span> <span class="p">=</span> <span class="mi">512</span><span class="p">;</span>
<span class="k">local</span> <span class="nx">PROJECTION_SIZE</span> <span class="p">=</span> <span class="mi">64</span><span class="p">;</span>
<span class="k">local</span> <span class="nx">FINAL_OUTPUT_SIZE</span> <span class="p">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="k">local</span> <span class="nx">DROPOUT</span> <span class="p">=</span> <span class="mf">0.25</span><span class="p">;</span>
<span class="k">local</span> <span class="nx">NUM_PROJECTION_LAYERS</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">local</span> <span class="nx">ENCODER</span> <span class="p">=</span> <span class="p">{</span>
     <span class="s">"spec"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"num_layers"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s">"activations"</span><span class="p">:</span> <span class="p">[</span><span class="s">"relu"</span><span class="p">,</span> <span class="s">"relu"</span><span class="p">],</span>
            <span class="s">"input_dim"</span><span class="p">:</span> <span class="nx">INPUT_SIZE</span><span class="p">,</span>
            <span class="s">"hidden_dims"</span><span class="p">:</span> <span class="nx">INPUT_ENCODER_OUTPUT_SIZE</span><span class="p">,</span>
            <span class="s">"dropout"</span><span class="p">:</span> <span class="nx">DROPOUT</span>
      <span class="p">}</span>
<span class="p">};</span>

<span class="nx">lib</span><span class="p">.</span><span class="nx">MNIST</span><span class="p">(</span><span class="nx">ENCODER</span><span class="p">.</span><span class="nx">spec</span><span class="p">,</span> <span class="nx">PROJECTION_SIZE</span><span class="p">,</span> <span class="nx">FINAL_OUTPUT_SIZE</span><span class="p">,</span> <span class="nx">DROPOUT</span><span class="p">,</span> <span class="nx">NUM_PROJECTION_LAYERS</span><span class="p">);</span>
</code></pre></div></div>

<h5 id="mnist_convjsonnet-2">
<a class="anchor" href="#mnist_convjsonnet-2" aria-hidden="true"><span class="octicon octicon-link"></span></a>mnist_conv.jsonnet</h5>

<div class="language-jsonnet highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">local</span> <span class="nx">lib</span> <span class="p">=</span> <span class="k">import</span> <span class="s">"lib-mnist.libsonnet"</span><span class="p">;</span>

<span class="k">local</span> <span class="nx">INPUT_SIZE</span> <span class="p">=</span> <span class="mi">784</span><span class="p">;</span>
<span class="k">local</span> <span class="nx">PROJECTION_SIZE</span> <span class="p">=</span> <span class="mi">64</span><span class="p">;</span>
<span class="k">local</span> <span class="nx">FINAL_OUTPUT_SIZE</span> <span class="p">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="k">local</span> <span class="nx">DROPOUT</span> <span class="p">=</span> <span class="mf">0.25</span><span class="p">;</span>
<span class="k">local</span> <span class="nx">NUM_PROJECTION_LAYERS</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">local</span> <span class="nx">ConvSpec</span> <span class="p">=</span> <span class="p">{</span>
    <span class="s">"num_layers"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s">"input_dim"</span><span class="p">:</span> <span class="nx">INPUT_SIZE</span><span class="p">,</span>
    <span class="s">"kernels"</span><span class="p">:</span> <span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span>
    <span class="s">"stride"</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="s">"activations"</span><span class="p">:</span> <span class="p">[</span><span class="s">"relu"</span><span class="p">,</span> <span class="s">"relu"</span><span class="p">],</span>
    <span class="s">"output_channels"</span><span class="p">:</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">],</span>
    <span class="s">"output_sizes"</span><span class="p">:</span> <span class="nx">compute_conv_output_sizes</span><span class="p">(</span><span class="k">self</span><span class="p">,</span> <span class="k">self</span><span class="p">.</span><span class="nx">input_dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s">"output_size"</span><span class="p">:</span> <span class="k">self</span><span class="p">.</span><span class="nx">output_sizes</span><span class="p">[</span><span class="mi">-1</span><span class="p">]</span>
<span class="p">};</span>

<span class="k">local</span> <span class="nx">ConvEncoder</span> <span class="p">=</span> <span class="p">{</span>
    <span class="s">"spec"</span><span class="p">:</span>  <span class="p">{</span>
            <span class="s">"type"</span><span class="p">:</span> <span class="s">"conv2d"</span>
            <span class="s">"num_layers"</span><span class="p">:</span> <span class="nx">ConvSpec</span><span class="p">.</span><span class="nx">num_layers</span><span class="p">,</span>
            <span class="s">"input_dim"</span><span class="p">:</span> <span class="nx">ConvSpec</span><span class="p">.</span><span class="nx">input_dim</span><span class="p">,</span>
            <span class="s">"output_channels"</span><span class="p">:</span> <span class="nx">ConvSpec</span><span class="p">.</span><span class="nx">output_channels</span><span class="p">,</span>
            <span class="s">"kernels"</span><span class="p">:</span> <span class="nx">ConvSpec</span><span class="p">.</span><span class="nx">kernels</span><span class="p">,</span>
            <span class="s">"stride"</span><span class="p">:</span> <span class="nx">ConvSpec</span><span class="p">.</span><span class="nx">stride</span><span class="p">,</span>
            <span class="s">"activations"</span><span class="p">:</span> <span class="nx">ConvSpec</span><span class="p">.</span><span class="nx">activations</span>
      <span class="p">}</span>
<span class="p">};</span>

<span class="nx">lib</span><span class="p">.</span><span class="nx">MNIST</span><span class="p">(</span><span class="nx">ConvEncoder</span><span class="p">.</span><span class="nx">spec</span><span class="p">,</span> <span class="nx">PROJECTION_SIZE</span><span class="p">,</span> <span class="nx">FINAL_OUTPUT_SIZE</span><span class="p">,</span> <span class="nx">DROPOUT</span><span class="p">,</span> <span class="nx">NUM_PROJECTION_LAYERS</span><span class="p">)</span>
</code></pre></div></div>

<p>Now this kind of a setup would allow to easily bring in rapid prototyping and experimentation. Just replace the encoder with RNN or Self Attention based layers and pass it to <code class="language-plaintext highlighter-rouge">lib.MNIST</code>.</p>

<p>Jsonnet brings in a lot of flexibility to defining configurations as we have seen above. There are a lot more interesting things that could be done with respect to configuring neural net experiments with Jsonnet. Imagine writing a grid search procedure in Jsonnet that would generate all possible configurations for the different hyperparameter combinations. That wouldn’t be too difficult I guess. A lot of interesting example experiment configurations can be found in <a href="https://github.com/allenai/allennlp/tree/master/training_config">AllenNLP’s source here</a>.</p>

  </div><a class="u-url" href="/personal-site/deep-learning/software/2019/07/06/jsonnet.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/personal-site/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/personal-site/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/personal-site/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Stuff</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/scarecrow1123" title="scarecrow1123"><svg class="svg-icon grey"><use xlink:href="/personal-site/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/sri-ananda-seelan-lakshmi-narasimhan-86330776" title="sri-ananda-seelan-lakshmi-narasimhan-86330776"><svg class="svg-icon grey"><use xlink:href="/personal-site/assets/minima-social-icons.svg#linkedin"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
